<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Store Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Noto Sans Devanagari', sans-serif;
        }
        
        .scanner-container {
            width: 100%;
            max-width: 350px;
            margin: 0 auto;
            border: 2px solid #3B82F6;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
        }
        
        #reader, #storeReader, #shoppingReader {
            width: 100% !important;
            border-radius: 8px;
        }
        
        #reader video, #storeReader video, #shoppingReader video {
            border-radius: 8px !important;
            object-fit: cover !important;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-lg sticky top-0 z-50">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between">
                <h1 id="storeName" class="text-xl font-bold text-gray-800 cursor-pointer" onclick="editStoreName()">मेरा स्टोर</h1>
                <div class="flex space-x-2">
                    <button onclick="exportData()" class="p-2 bg-green-500 text-white rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    <button onclick="document.getElementById('importFile').click()" class="p-2 bg-blue-500 text-white rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="bg-white border-t">
        <div class="flex">
            <button onclick="showSection('store')" id="storeTab" class="flex-1 py-3 px-4 text-center font-medium text-blue-600 border-b-2 border-blue-600">
                स्टोर
            </button>
            <button onclick="showSection('shopping')" id="shoppingTab" class="flex-1 py-3 px-4 text-center font-medium text-gray-500">
                शॉपिंग
            </button>
            <button onclick="showSection('history')" id="historyTab" class="flex-1 py-3 px-4 text-center font-medium text-gray-500">
                हिस्ट्री
            </button>
        </div>
    </div>

    <!-- Store Section -->
    <div id="storeSection" class="p-4">
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h2 class="text-lg font-semibold mb-3">नया प्रोडक्ट जोड़ें</h2>
            
            <div class="mb-4">
                <button onclick="startScanning('store')" id="storeScanBtn" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg mb-2">
                    बारकोड स्कैन करें
                </button>
                <div id="storeScanner" class="scanner-container hidden mb-4">
                    <div id="storeReader"></div>
                    <button onclick="stopScanning('store')" class="w-full bg-red-500 text-white py-2 px-4 rounded-lg mt-2">
                        स्कैन बंद करें
                    </button>
                </div>
            </div>

            <div class="space-y-3">
                <input type="text" id="productBarcode" placeholder="बारकोड (मैन्युअल)" class="w-full p-3 border rounded-lg">
                <input type="text" id="productName" placeholder="प्रोडक्ट का नाम" class="w-full p-3 border rounded-lg" required>
                <input type="number" id="productPrice" placeholder="कीमत (₹)" class="w-full p-3 border rounded-lg" required>
                <textarea id="productDetails" placeholder="विवरण" class="w-full p-3 border rounded-lg h-20"></textarea>
                <button onclick="addProduct()" class="w-full bg-green-500 text-white py-3 px-4 rounded-lg font-medium">
                    प्रोडक्ट जोड़ें
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4">
            <h2 class="text-lg font-semibold mb-3">सभी प्रोडक्ट्स</h2>
            <div id="productsList" class="space-y-2">
                <!-- Products will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Shopping Section -->
    <div id="shoppingSection" class="p-4 hidden">
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h2 class="text-lg font-semibold mb-3">बिलिंग</h2>
            
            <div class="mb-4">
                <button onclick="startScanning('shopping')" id="shoppingScanBtn" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg mb-2">
                    प्रोडक्ट स्कैन करें
                </button>
                <div id="shoppingScanner" class="scanner-container hidden mb-4">
                    <div id="shoppingReader"></div>
                    <button onclick="stopScanning('shopping')" class="w-full bg-red-500 text-white py-2 px-4 rounded-lg mt-2">
                        स्कैन बंद करें
                    </button>
                </div>
            </div>

            <input type="text" id="searchProduct" placeholder="प्रोडक्ट खोजें या बारकोड डालें" class="w-full p-3 border rounded-lg mb-3" onkeyup="searchProducts(this.value)">
            
            <div id="searchResults" class="hidden mb-4">
                <!-- Search results will appear here -->
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h3 class="text-lg font-semibold mb-3">बिल आइटम्स</h3>
            <div id="billItems" class="space-y-2 mb-4">
                <!-- Bill items will be displayed here -->
            </div>
            <div class="border-t pt-3">
                <div class="flex justify-between items-center text-xl font-bold">
                    <span>कुल राशि:</span>
                    <span id="totalAmount">₹0</span>
                </div>
            </div>
            <div class="flex space-x-2 mt-4">
                <button onclick="saveBill()" class="flex-1 bg-green-500 text-white py-3 px-4 rounded-lg font-medium">
                    बिल सेव करें
                </button>
                <button onclick="printBill()" class="flex-1 bg-blue-500 text-white py-3 px-4 rounded-lg font-medium">
                    बिल प्रिंट करें
                </button>
            </div>
            <button onclick="clearBill()" class="w-full bg-red-500 text-white py-2 px-4 rounded-lg mt-2">
                बिल क्लियर करें
            </button>
        </div>
    </div>

    <!-- History Section -->
    <div id="historySection" class="p-4 hidden">
        <div class="bg-white rounded-lg shadow-md p-4">
            <h2 class="text-lg font-semibold mb-3">बिल हिस्ट्री</h2>
            <div id="billHistory" class="space-y-3">
                <!-- Bill history will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Print Area (Hidden) -->
    <div class="print-area hidden">
        <div id="printContent"></div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-semibold mb-4">प्रोडक्ट एडिट करें</h3>
                <div class="space-y-3">
                    <input type="text" id="editProductName" placeholder="प्रोडक्ट का नाम" class="w-full p-3 border rounded-lg">
                    <input type="number" id="editProductPrice" placeholder="कीमत (₹)" class="w-full p-3 border rounded-lg">
                    <textarea id="editProductDetails" placeholder="विवरण" class="w-full p-3 border rounded-lg h-20"></textarea>
                </div>
                <div class="flex space-x-2 mt-4">
                    <button onclick="updateProduct()" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg">
                        अपडेट करें
                    </button>
                    <button onclick="closeEditModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg">
                        कैंसल
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let products = JSON.parse(localStorage.getItem('products')) || {};
        let billItems = [];
        let billHistory = JSON.parse(localStorage.getItem('billHistory')) || [];
        let storeName = localStorage.getItem('storeName') || 'मेरा स्टोर';
        let currentEditingProduct = null;
        let html5QrCode = null;
        let isScanning = false;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('storeName').textContent = storeName;
            displayProducts();
            displayBillHistory();
            autoSave();
        });

        // Auto-save functionality
        function autoSave() {
            setInterval(() => {
                localStorage.setItem('products', JSON.stringify(products));
                localStorage.setItem('billHistory', JSON.stringify(billHistory));
                localStorage.setItem('storeName', storeName);
            }, 2000);
        }

        // Section navigation
        function showSection(section) {
            // Hide all sections
            document.getElementById('storeSection').classList.add('hidden');
            document.getElementById('shoppingSection').classList.add('hidden');
            document.getElementById('historySection').classList.add('hidden');
            
            // Remove active class from all tabs
            document.getElementById('storeTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('shoppingTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('historyTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            
            document.getElementById('storeTab').classList.add('text-gray-500');
            document.getElementById('shoppingTab').classList.add('text-gray-500');
            document.getElementById('historyTab').classList.add('text-gray-500');
            
            // Show selected section
            document.getElementById(section + 'Section').classList.remove('hidden');
            document.getElementById(section + 'Section').classList.add('fade-in');
            
            // Add active class to selected tab
            const activeTab = document.getElementById(section + 'Tab');
            activeTab.classList.remove('text-gray-500');
            activeTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        }

        // Store name editing
        function editStoreName() {
            const newName = prompt('स्टोर का नाम बदलें:', storeName);
            if (newName && newName.trim()) {
                storeName = newName.trim();
                document.getElementById('storeName').textContent = storeName;
                localStorage.setItem('storeName', storeName);
            }
        }

        // Barcode scanning
        function startScanning(section) {
            if (isScanning) return;
            
            const scannerDiv = document.getElementById(section + 'Scanner');
            const readerDiv = document.getElementById(section + 'Reader');
            const scanBtn = document.getElementById(section + 'ScanBtn');
            
            scannerDiv.classList.remove('hidden');
            scanBtn.disabled = true;
            isScanning = true;
            
            html5QrCode = new Html5Qrcode(section + 'Reader');
            
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    // Try to find back camera first
                    let cameraId = devices[0].id;
                    
                    // Look for back camera (environment facing)
                    const backCamera = devices.find(device => 
                        device.label.toLowerCase().includes('back') || 
                        device.label.toLowerCase().includes('rear') ||
                        device.label.toLowerCase().includes('environment')
                    );
                    
                    if (backCamera) {
                        cameraId = backCamera.id;
                    } else if (devices.length > 1) {
                        // If multiple cameras, usually the second one is back camera
                        cameraId = devices[devices.length - 1].id;
                    }
                    
                    html5QrCode.start(
                        cameraId,
                        {
                            fps: 10,
                            qrbox: { width: 280, height: 280 },
                            aspectRatio: 1.0,
                            disableFlip: false,
                            videoConstraints: {
                                facingMode: "environment", // This forces back camera
                                focusMode: "continuous",
                                advanced: [
                                    { focusMode: "continuous" },
                                    { focusDistance: { min: 0.1, max: 10 } }
                                ]
                            }
                        },
                        (decodedText, decodedResult) => {
                            if (section === 'store') {
                                document.getElementById('productBarcode').value = decodedText;
                            } else if (section === 'shopping') {
                                addToBill(decodedText);
                            }
                            stopScanning(section);
                        },
                        (errorMessage) => {
                            // Handle scan error silently
                        }
                    ).catch(err => {
                        console.log('Error starting scanner:', err);
                        // Try with basic constraints if advanced fails
                        html5QrCode.start(
                            { facingMode: "environment" },
                            {
                                fps: 10,
                                qrbox: { width: 280, height: 280 }
                            },
                            (decodedText, decodedResult) => {
                                if (section === 'store') {
                                    document.getElementById('productBarcode').value = decodedText;
                                } else if (section === 'shopping') {
                                    addToBill(decodedText);
                                }
                                stopScanning(section);
                            },
                            (errorMessage) => {
                                // Handle scan error silently
                            }
                        ).catch(err2 => {
                            console.log('Fallback scanner also failed:', err2);
                            stopScanning(section);
                            alert('कैमरा एक्सेस नहीं मिल सका। कृपया मैन्युअल बारकोड डालें।');
                        });
                    });
                }
            }).catch(err => {
                console.log('Error getting cameras:', err);
                alert('कैमरा एक्सेस नहीं मिल सका। कृपया मैन्युअल बारकोड डालें।');
                stopScanning(section);
            });
        }

        function stopScanning(section) {
            if (html5QrCode && isScanning) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                }).catch(err => {
                    console.log('Error stopping scanner:', err);
                });
            }
            
            const scannerDiv = document.getElementById(section + 'Scanner');
            const scanBtn = document.getElementById(section + 'ScanBtn');
            
            scannerDiv.classList.add('hidden');
            scanBtn.disabled = false;
            isScanning = false;
        }

        // Product management
        function addProduct() {
            const barcode = document.getElementById('productBarcode').value.trim();
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const details = document.getElementById('productDetails').value.trim();

            if (!name || !price) {
                alert('कृपया प्रोडक्ट का नाम और कीमत डालें।');
                return;
            }

            const productId = barcode || Date.now().toString();
            
            products[productId] = {
                id: productId,
                barcode: barcode,
                name: name,
                price: price,
                details: details,
                dateAdded: new Date().toLocaleString('hi-IN')
            };

            // Clear form
            document.getElementById('productBarcode').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productDetails').value = '';

            displayProducts();
            alert('प्रोडक्ट सफलतापूर्वक जोड़ा गया!');
        }

        function displayProducts() {
            const productsList = document.getElementById('productsList');
            productsList.innerHTML = '';

            if (Object.keys(products).length === 0) {
                productsList.innerHTML = '<p class="text-gray-500 text-center py-4">कोई प्रोडक्ट नहीं मिला</p>';
                return;
            }

            Object.values(products).forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'bg-gray-50 p-3 rounded-lg border';
                productDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-800">${product.name}</h4>
                            <p class="text-green-600 font-semibold">₹${product.price}</p>
                            ${product.barcode ? `<p class="text-xs text-gray-500">बारकोड: ${product.barcode}</p>` : ''}
                            ${product.details ? `<p class="text-sm text-gray-600 mt-1">${product.details}</p>` : ''}
                        </div>
                        <div class="flex space-x-1 ml-2">
                            <button onclick="editProduct('${product.id}')" class="p-1 bg-blue-500 text-white rounded text-xs">
                                एडिट
                            </button>
                            <button onclick="deleteProduct('${product.id}')" class="p-1 bg-red-500 text-white rounded text-xs">
                                डिलीट
                            </button>
                        </div>
                    </div>
                `;
                productsList.appendChild(productDiv);
            });
        }

        function editProduct(productId) {
            const product = products[productId];
            if (!product) return;

            currentEditingProduct = productId;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductDetails').value = product.details || '';
            document.getElementById('editModal').classList.remove('hidden');
        }

        function updateProduct() {
            if (!currentEditingProduct) return;

            const name = document.getElementById('editProductName').value.trim();
            const price = parseFloat(document.getElementById('editProductPrice').value);
            const details = document.getElementById('editProductDetails').value.trim();

            if (!name || !price) {
                alert('कृपया प्रोडक्ट का नाम और कीमत डालें।');
                return;
            }

            products[currentEditingProduct].name = name;
            products[currentEditingProduct].price = price;
            products[currentEditingProduct].details = details;

            closeEditModal();
            displayProducts();
            alert('प्रोडक्ट अपडेट हो गया!');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditingProduct = null;
        }

        function deleteProduct(productId) {
            if (confirm('क्या आप इस प्रोडक्ट को डिलीट करना चाहते हैं?')) {
                delete products[productId];
                displayProducts();
            }
        }

        // Shopping functionality
        function searchProducts(query) {
            const searchResults = document.getElementById('searchResults');
            
            if (!query.trim()) {
                searchResults.classList.add('hidden');
                return;
            }

            const results = Object.values(products).filter(product => 
                product.name.toLowerCase().includes(query.toLowerCase()) ||
                product.barcode === query
            );

            if (results.length === 0) {
                searchResults.innerHTML = '<p class="text-gray-500 p-2">कोई प्रोडक्ट नहीं मिला</p>';
                searchResults.classList.remove('hidden');
                return;
            }

            searchResults.innerHTML = results.map(product => `
                <div class="bg-gray-50 p-2 rounded border cursor-pointer hover:bg-gray-100" onclick="addToBill('${product.id}')">
                    <div class="font-medium">${product.name}</div>
                    <div class="text-green-600">₹${product.price}</div>
                </div>
            `).join('');
            
            searchResults.classList.remove('hidden');
        }

        function addToBill(productId) {
            const product = products[productId];
            if (!product) {
                alert('प्रोडक्ट नहीं मिला!');
                return;
            }

            const existingItem = billItems.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                billItems.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }

            document.getElementById('searchProduct').value = '';
            document.getElementById('searchResults').classList.add('hidden');
            displayBillItems();
            updateTotal();
        }

        function displayBillItems() {
            const billItemsDiv = document.getElementById('billItems');
            
            if (billItems.length === 0) {
                billItemsDiv.innerHTML = '<p class="text-gray-500 text-center py-4">कोई आइटम नहीं</p>';
                return;
            }

            billItemsDiv.innerHTML = billItems.map((item, index) => `
                <div class="bg-gray-50 p-3 rounded border">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <h4 class="font-medium">${item.name}</h4>
                            <p class="text-sm text-gray-600">₹${item.price} x ${item.quantity} = ₹${(item.price * item.quantity).toFixed(2)}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="updateQuantity(${index}, -1)" class="w-8 h-8 bg-red-500 text-white rounded-full text-sm">-</button>
                            <span class="w-8 text-center">${item.quantity}</span>
                            <button onclick="updateQuantity(${index}, 1)" class="w-8 h-8 bg-green-500 text-white rounded-full text-sm">+</button>
                            <button onclick="removeFromBill(${index})" class="w-8 h-8 bg-gray-500 text-white rounded-full text-sm">×</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateQuantity(index, change) {
            billItems[index].quantity += change;
            if (billItems[index].quantity <= 0) {
                billItems.splice(index, 1);
            }
            displayBillItems();
            updateTotal();
        }

        function removeFromBill(index) {
            billItems.splice(index, 1);
            displayBillItems();
            updateTotal();
        }

        function updateTotal() {
            const total = billItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('totalAmount').textContent = `₹${total.toFixed(2)}`;
        }

        function clearBill() {
            if (billItems.length > 0 && confirm('क्या आप बिल क्लियर करना चाहते हैं?')) {
                billItems = [];
                displayBillItems();
                updateTotal();
            }
        }

        function saveBill() {
            if (billItems.length === 0) {
                alert('बिल में कोई आइटम नहीं है!');
                return;
            }

            const bill = {
                id: Date.now(),
                date: new Date().toLocaleString('hi-IN'),
                items: [...billItems],
                total: billItems.reduce((sum, item) => sum + (item.price * item.quantity), 0)
            };

            billHistory.unshift(bill);
            clearBill();
            displayBillHistory();
            alert('बिल सेव हो गया!');
        }

        function printBill() {
            if (billItems.length === 0) {
                alert('बिल में कोई आइटम नहीं है!');
                return;
            }

            const total = billItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const printContent = `
                <div style="font-family: 'Noto Sans Devanagari', sans-serif; max-width: 300px; margin: 0 auto; padding: 20px;">
                    <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px;">
                        <h2 style="margin: 0; font-size: 24px;">${storeName}</h2>
                        <p style="margin: 5px 0;">बिल</p>
                        <p style="margin: 0; font-size: 12px;">${new Date().toLocaleString('hi-IN')}</p>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                        <thead>
                            <tr style="border-bottom: 1px solid #000;">
                                <th style="text-align: left; padding: 5px 0;">आइटम</th>
                                <th style="text-align: center; padding: 5px 0;">मात्रा</th>
                                <th style="text-align: right; padding: 5px 0;">राशि</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${billItems.map(item => `
                                <tr>
                                    <td style="padding: 3px 0; font-size: 14px;">${item.name}</td>
                                    <td style="text-align: center; padding: 3px 0;">${item.quantity}</td>
                                    <td style="text-align: right; padding: 3px 0;">₹${(item.price * item.quantity).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="border-top: 2px solid #000; padding-top: 10px;">
                        <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
                            <span>कुल राशि:</span>
                            <span>₹${total.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; font-size: 12px;">
                        <p>धन्यवाद!</p>
                    </div>
                </div>
            `;

            document.getElementById('printContent').innerHTML = printContent;
            window.print();
        }

        // History functionality
        function displayBillHistory() {
            const historyDiv = document.getElementById('billHistory');
            
            if (billHistory.length === 0) {
                historyDiv.innerHTML = '<p class="text-gray-500 text-center py-4">कोई बिल हिस्ट्री नहीं</p>';
                return;
            }

            historyDiv.innerHTML = billHistory.map(bill => `
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-medium">बिल #${bill.id}</h4>
                            <p class="text-sm text-gray-600">${bill.date}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-green-600">₹${bill.total.toFixed(2)}</p>
                            <button onclick="printOldBill(${bill.id})" class="text-xs bg-blue-500 text-white px-2 py-1 rounded mt-1">
                                प्रिंट
                            </button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600">
                        ${bill.items.map(item => `${item.name} (${item.quantity})`).join(', ')}
                    </div>
                </div>
            `).join('');
        }

        function printOldBill(billId) {
            const bill = billHistory.find(b => b.id === billId);
            if (!bill) return;

            const printContent = `
                <div style="font-family: 'Noto Sans Devanagari', sans-serif; max-width: 300px; margin: 0 auto; padding: 20px;">
                    <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px;">
                        <h2 style="margin: 0; font-size: 24px;">${storeName}</h2>
                        <p style="margin: 5px 0;">बिल #${bill.id}</p>
                        <p style="margin: 0; font-size: 12px;">${bill.date}</p>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                        <thead>
                            <tr style="border-bottom: 1px solid #000;">
                                <th style="text-align: left; padding: 5px 0;">आइटम</th>
                                <th style="text-align: center; padding: 5px 0;">मात्रा</th>
                                <th style="text-align: right; padding: 5px 0;">राशि</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bill.items.map(item => `
                                <tr>
                                    <td style="padding: 3px 0; font-size: 14px;">${item.name}</td>
                                    <td style="text-align: center; padding: 3px 0;">${item.quantity}</td>
                                    <td style="text-align: right; padding: 3px 0;">₹${(item.price * item.quantity).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="border-top: 2px solid #000; padding-top: 10px;">
                        <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
                            <span>कुल राशि:</span>
                            <span>₹${bill.total.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; font-size: 12px;">
                        <p>धन्यवाद!</p>
                    </div>
                </div>
            `;

            document.getElementById('printContent').innerHTML = printContent;
            window.print();
        }

        // Data import/export
        function exportData() {
            const data = {
                storeName: storeName,
                products: products,
                billHistory: billHistory,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${storeName}_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('क्या आप वाकई डेटा इम्पोर्ट करना चाहते हैं? यह मौजूदा डेटा को बदल देगा।')) {
                        if (data.storeName) storeName = data.storeName;
                        if (data.products) products = data.products;
                        if (data.billHistory) billHistory = data.billHistory;
                        
                        document.getElementById('storeName').textContent = storeName;
                        displayProducts();
                        displayBillHistory();
                        
                        alert('डेटा सफलतापूर्वक इम्पोर्ट हो गया!');
                    }
                } catch (error) {
                    alert('गलत फाइल फॉर्मेट! कृपया सही JSON फाइल चुनें।');
                }
            };
            reader.readAsText(file);
            
            // Clear the input
            event.target.value = '';
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'972f28e1d77741c9',t:'MTc1NTgzMjA0NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
